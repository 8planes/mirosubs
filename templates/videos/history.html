{% extends "base.html" %}

{% load escapejs paginator widget %}

{% block css %}
  {{ block.super }}
  <link href="{{ MEDIA_URL }}css/mirosubs-widget.css" media="all" type="text/css" rel="stylesheet" />
  <style>
    div.mirosubs-widget {
        position: relative;    
    }
    .mirosubs-videoDiv {
        text-align: center;
    }
    .mirosubs-videoDiv video {
        width: 460px;
    }
    
    #embed{
      white-space: pre;
      background: #eee;
      boder: #666;
    }
  </style>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  {% include "widget/_js_onsite_dependencies.html" %}
  <script type="text/javascript">
        //create url template
        var DIFFING_URL = function(){
            var url = '{% block diffing_link %}{% url videos:diffing 11111 22222 %}{% endblock %}';
            return url.replace(/11111/, '<<first_pk>>').replace(/22222/, '<<second_pk>>');
        }();
        
        function get_compare_link(first_pk, second_pk){
            //set values from arguents
            return DIFFING_URL.replace(/<<first_pk>>/, first_pk).replace(/<<second_pk>>/, second_pk);
        }

        jQuery(document).ready(function($){
            $('.version_checkbox:first').attr('checked', 'checked');
            
            $('.version_checkbox').change(function(){
                var $this = $(this);
                var checked_length = $('.version_checkbox:checked').length;
                
                if($this.attr('checked') && (checked_length > 2)){
                    $this.attr('checked', '');
                }
            });
            
            $('.compare_versions_button').click(function(){
                var $checked = $('.version_checkbox:checked');
                if ($checked.length !== 2){
                    alert('Select two revisions for compare, please');
                }else{
                    var url = get_compare_link($checked[0].value, $checked[1].value);
                    window.location.replace(url);
                }
            });
        });
    </script>
{% endblock %}

{% block main_content %}
    <h2>{{ video }}</h2>
    <p class="what_lang">
        {% block lang_display %}
            in <a href="{% url videos:video video_id=video.video_id %}">Original Language</a>
        {% endblock %}
    </p>
    
    <div class="left_column">
        {% widget video.get_video_url %}
    </div>
    
    <div class="right_column">
        {% block translation_list %}
            {% if translations %}
                <p class="other_lang">
                    Other Languages:
                        {% for item in translations %}
                            <a href="{% url videos:translation_history video.video_id item.language %}">{{ item.get_language_display }}</a>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                 </p>             
            {% endif %}
        {% endblock %}
    </div>
    
    <div class="clear">&nbsp;</div>
    
    <h2 class="floatleft margin-top">Recent Revisions <a class="whats_this" href="{% url faq_page %}#revisions">(What's This?)</a></h2>
    
    <button class="compare_versions_button"><span>Compare Revisions</span></button>
    {% if revision_list %}
    
    {% block table %}
    <ul class="table_head">
      <li class="table_most_recent">{% ordered_column "date" "Most Recent" %}</li>
      <li class="table_user">{% ordered_column "user" "User" %}</li>
      <li class="table_note">{% ordered_column "note" "Note" %}</li>
      <li class="table_time">{% ordered_column "time" "Time" %}</li>
      <li class="table_text">{% ordered_column "text" "Text" %}</li>
    </ul>
   
   <ul class="table_body"> 
    {% for item in revision_list %}
          <li>
            <ul>
              <li class="table_most_recent"><input type="checkbox" class="version_checkbox" value="{{ item.pk }}"/> {{ item.revision_time }} (#{{ item.version_no}}) <a class="view_history" href="{% url videos:revision pk=item.pk %}">view</a></li>
              <li class="table_user">
                  <a href="{% url profiles:profile item.user.pk %}">{{ item.user.username }}</a>
              </li>
              <li class="table_note">{% if item.note %}{{ item.note }}{% else %}&nbsp;{% endif %}</li>
              <li class="table_time">{{ item.time_change_display }}</li>
              <li class="table_text">{{ item.text_change_display }}</li>

            </ul>
          </li>    
    {% endfor %}
   </ul> 
   <div style="clear: both"/>
   {% if is_paginated %}{% ordered_paginator 3 %}{% endif %} 

   {% endblock %} 
   {% endif %}
{% endblock %}
