{% extends "base.html" %}

{% load escapejs paginator widget comments %}

{% block css %}
    {{ block.super }}
    <link href="{{ MEDIA_URL }}css/mirosubs-widget.css" media="all" type="text/css" rel="stylesheet" />
    <style>
        div.mirosubs-widget {
            position: relative;
        }
        
        .mirosubs-videoDiv {
            text-align: center;
        }
        
        .mirosubs-videoDiv video {
            width: 460px;
        }
        
        #embed {
            white-space: pre;
            background: #eee;
            boder: #666;
        }
    </style>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    {% include "widget/_js_onsite_dependencies.html" %}
    <script type="text/javascript">
        //create url template
        var DIFFING_URL = function(){
            var url = '{% block diffing_link %}{% url videos:diffing 11111 22222 %}{% endblock %}';
            return url.replace(/11111/, '<<first_pk>>').replace(/22222/, '<<second_pk>>');
        }();
        
        function get_compare_link(first_pk, second_pk){
            //set values from arguents
            return DIFFING_URL.replace(/<<first_pk>>/, first_pk).replace(/<<second_pk>>/, second_pk);
        }
        
        jQuery(document).ready(function($){
            $('.version_checkbox:first').attr('checked', 'checked');
            
            $('.version_checkbox').change(function(){
                var $this = $(this);
                var checked_length = $('.version_checkbox:checked').length;
                
                if ($this.attr('checked') && (checked_length > 2)) {
                    $this.attr('checked', '');
                }
            });
            
            $('.compare_versions_button').click(function(){
                var $checked = $('.version_checkbox:checked');
                if ($checked.length !== 2) {
                    alert('Select two revisions for compare, please');
                }
                else {
                    var url = get_compare_link($checked[0].value, $checked[1].value);
                    window.location.replace(url);
                }
            });
            //******** Tabs ********//
            var $last_active_tab = $($('.video_tabs li.active a').attr('href'));
            $('.video_tabs a').click(function(){
                $last_active_tab.hide();
                $last_active_tab = $($(this).attr('href')).show();
                $('.video_tabs li').removeClass('active');
                $(this).parent('li').addClass('active');
                return false;
            });
                        
            if (document.location.hash){
                $('a[href='+document.location.hash.split('?', 1)+']').click();
            }
        });
    </script>
{% endblock %}

{% block main_content %}
    <h2>{{ video }}</h2>
    <p class="what_lang">
        {% block lang_display %} 
        in <a href="{% url videos:video video_id=video.video_id %}">Original Language</a>
        {% endblock %}
        {% block translation_list %}
            {% if translations %}
                <p class="other_lang">
                    Other Languages:
                        {% for item in translations %}
                            <a href="{% url videos:translation_history video.video_id item.language %}">{{ item.get_language_display }}</a>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                 </p>
            {% endif %}
        {% endblock %}        
    </p>
    <div class="left_column">
        {% widget widget_params %}
    </div>
    <div class="right_column"></div>
    
    <div class="clearboth">&nbsp;</div>

    <ul class="video_tabs">
      <li class="active"><a href="#trascript-tab">Original Subtitles</a></li>
      <li><a href="#comments">Comments ({% get_comment_count commented_video %})</a></li>
      <li><a href="#revision-tab">Versions ({{ hits }})</a></li>
    </ul>
    
    <div style="display: none" id="revision-tab" class="tab">
        {% if revision_list|length > 1 %}
            <button class="compare_versions_button">
                <span>Compare Revisions</span>
            </button>
        {% endif %}
        
        {% if revision_list %}
           {% if is_paginated %}{% ordered_paginator 3 %}{% endif %} 

           {% block table %}
            <ul class="table_head">
                <li class="table_most_recent">
                    {% ordered_column "date" "Most Recent" %}
                </li>
                <li class="table_user">
                    {% ordered_column "user" "User" %}
                </li>
                <li class="table_note">
                    {% ordered_column "note" "Note" %}
                </li>
                <li class="table_time">
                    {% ordered_column "time" "Time" %}
                </li>
                <li class="table_text">
                    {% ordered_column "text" "Text" %}
                </li>
            </ul>
            
            <ul class="table_body">
                {% for item in revision_list %}
                <li {% cycle 'class="even"' '' %}>
                    <ul>
                        <li class="table_most_recent">
                            <input type="checkbox" class="version_checkbox" value="{{ item.pk }}"/>{{ item.revision_time }} (#{{ item.version_no}}) <a class="view_history" href="{% url videos:revision pk=item.pk %}">view</a>
                        </li>
                        <li class="table_user">
                            <a href="{% url profiles:profile item.user.pk %}">{{ item.user.username }}</a>
                        </li>
                        <li class="table_note">
                            {% if item.note %}{{ item.note }}{% else %}&nbsp;{% endif %}
                        </li>
                        <li class="table_time">
                            {{ item.time_change_display }}
                        </li>
                        <li class="table_text">
                            {{ item.text_change_display }}
                        </li>
                    </ul>
                </li>
                {% endfor %}
            </ul>
            
            <div style="clear: both"></div>
           {% endblock %}
       {% else %}
            <div class="nothing">
                <strong>This revision has no subtitles</strong><br />
                Either no subtitles have been entered, or they were deleted.
            </div>
       {% endif %}
   </div>
   
   <div style="display: none" id="comments" class="tab">
       {% block comments %}
           {% render_comment_form commented_video %}
           {% render_comment_list commented_video %}
       {% endblock %}
       <div style="clear: both"></div>     
   </div>
   
   <div id="trascript-tab" class="tab">
        <ul class="table_body"> 
            {% for item in last_version.captions %}
                <li class="table_transcript {% cycle 'even' '' %}">
                    {{ item.text }}
                </li>
            {% endfor %}
        </ul>
       <div style="clear: both"></div>   
   </div>
{% endblock %}

